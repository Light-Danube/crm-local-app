<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/src/components/styles/index.css" />
    <title>Video Controller</title>
  </head>
  <body>
    <header>
      <div class="container container__header">
        <a href="/">
          <img
            src="/src/components/img/image_1.png"
            alt="img not found"
            class="logo"
        /></a>
        <a
          href="https://crm.ucreate.org.ua/"
          class="header__link"
          target="_blank"
          rel="noreferrer"
        >
          Посилання на сайт
        </a>
      </div>
    </header>
    <main>
      <div class="container">
        <div class="container_search">
          <div class="form_search">
            <div class="info">
              <!-- Instruction Set -->
              <p class="text_op" ><strong>ПРОЧИТАЙТЕ ІНСТРУКЦІЮ!!!</strong></p>
              <p class="text_op" id="connectedPuppets"></p>
              <p class="text_op" id="showConnectionID">
                Скопіююйте наступний код у вашу /video сторінку, щоб приєднатися до цього контролера.
                Код: ${masterPageID}
              </p>

              <!-- Form to upload local videos -->
              <label for="search-name" class="input_label" id="fileInputLabel">
                <div class="container_change">
                  <div class="input__wrapper">
                    <input name="file" type="file" id="videoFile" name="video" class="input input__file" multiple>
                    <label for="videoFile" class="input__file-button">
                       <span class="input__file-icon-wrapper"><img class="input__file-icon" src="/src/components/img/download.svg" alt="Виберіть файл" width="25"></span>
                       <span class="input__file-button-text">Виберіть файл</span>
                    </label>
                 </div>
                </div>
              </label>

              <!-- Form to stream YouTube videos -->
              <label for="search-name" class="input_label">
                <div class="container_change">
                  <input
                    class="input_search"
                    type="text" 
                    id="youtubeUrlInput"
                    name="search-name"
                    placeholder="https://"/>
                    <!-- style="display: none;"-->  
                </div>
              </label>
          
              <!-- VIDEO EFFECTS BUTTONS:-->
              <p class="text_op">Параметри відео</p>

              <label class="label_form" for="optimizeButton">
                Оптимізувати відео
           
                    <input type="checkbox" id="optimizeButton" class="input_checkbox">
                  <span class="btn_check">
                    <span class="switching"></span>
                </span>
              </label>

              <label class="label_form" for="enhanceDetailsCheckbox">
                Деталізувати
               
                    <input type="checkbox" id="enhanceDetailsCheckbox" class="input_checkbox">
                    <span class="btn_check">
                    <span class="switching"></span>
                </span>
              </label>

              <label class="label_form" for="optimizeColorButton">
                Оптимізувати колір
               
                    <input type="checkbox" id="optimizeColorButton" class="input_checkbox">
                    <span class="btn_check">
                    <span class="switching"></span>
                </span>
              </label>

              <label class="label_form" for="optimizeBackground">
                Оптимізувати фон
              
                    <input type="checkbox" id="optimizeBackground" class="input_checkbox">
                    <span class="btn_check">
                    <span class="switching"></span>
                </span>
              </label>
              
              <p class="text_op">Звук</p>
              <!-- Volume control -->
              <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="1" />

              <!-- Endlessly Loop Video button-->
              <label class="label_form" for="toggleLoopButton">
                Зациклити відео
           
                  <input type="checkbox" id="toggleLoopButton" class="input_checkbox">
                  <span class="btn_check">
                  <span class="switching"></span>
                </span>
              </label>
              <!-- Stop button -->
              <label class="label_form" for="stopButton">
                Зупинити відео примусово
        
                  <input type="checkbox" id="stopButton" class="input_checkbox">
                  <span class="btn_check">
                  <span class="switching"></span>
                </span>
              </label>

              <!-- Upload / Steam Video-->
              <label class="label_form" for="">
                Вивести на екран
                <button class="btn_submit" 
                  id="uploadButton"
                  style="display: none;">
                  <img
                  class="img__click"
                  src="/src/components/img/click_me.svg"
                  alt="Click-me not found"
                />
                </button>

                <button class="btn_submit" 
                  id="streamButton" 
                  type="submit"
                  style="display: none;">
                  <img
                  class="img__click"
                  src="/src/components/img/click_me.svg"
                  alt="Click-me not found"
                />
                </button>
              </label>
          
              <!-- Modal -->
              <button class = "btn_information" id="btn_information">
                Інструкція
              </button>
          
              <!-- Information Modal -->
              <div id="infoModal" class="modal">
                <!-- Modal content -->
                <div class="modal-content">
                  <span class="close">&times;</span>
                  <h2>ІНСТРУКЦІЯ З ВИКОРИСТАННЯ</h2>
                  <p><strong>Код Доступу:</strong> Додаток працює наступним чином: є сторінка-контролер та керована сторінка. 
                    Для підлючення керованої сторінки до контролера вам необхідно скопіювати код у полі "КОД ДОСТУПУ" та вставити його у 
                    текстове поле на керованій сторінці. Текстове поле викликається натиском на кнопку "Під'єднатися"
                  </p>
                  <p><strong>Трансляція</strong>:</strong> Після цього завантажте ваше відео з пристороя чи вставте посилання з ютубу, 
                    далі натисність кнопку "вивести на екран" і керуйте за допомогою медіаплеера на сторінці-контролері (тобто цій);
                    УВАГА! 
                    - Деякі відео з ютубу можуть відтворюватися без звуку, це властивість ютубу.
                    - Також такі відео можуть здаватися "розсинхронизованими": просто розпочніть відео з початку.
                  </p>
                  <p><strong>ПРОБЛЕМИ:</strong>
                    - Звук пропав на деяких пристроях!: Я не можу підказати чому і як, спробуй перепідключитися.
                    - Розсинхрон!: Просто розпочни відео зпочатку, має допомогти;
                    - Відео не відтворюється!: Клікні на екрані керованого пристрою, якщо не допоможе - я хз;
                    - Ефекти розсинхроні!: Перезапусти сторінку, може спрацювати. Впливу з інших "мастерів" бути не може;
                    - Відео не зупиняется!/не починается!: Скоріш за все сервер "впав";
                  </p>
                  <h2>ДОДАТКОВІ ЕФЕКТИ ВІДЕО</h2>
                  <p><strong>Оптимізувати колір:</strong> Впливає на контраст кольорів, жовтий тон;.</p>
                  <p><strong>Деталізувати:</strong> Додавання "деталів" на відео.</p>
                  <p><strong>Оптимізувати Відео</strong> Перевертає по горизонталі та зміщує трішечки праворуч.</p>
                  <p><strong>Оптимізувати Фон:</strong> Зміна "фону" відео, помаранчевий колір, інше.</p>
                </div>
              </div>
            </div>
          </div>

          <div class="line"></div>

          <!-- Video player -->
          <div class="video_box">
            <video id="videoPlayer" controls muted>
              <source type="video/mp4">
            </video>
          </div>
        </div>
      </div>
    </main>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const videoFileInputBox = document.getElementById("fileInputLabel");
      const videoFileInput = document.getElementById("videoFile");
      const videoPlayer = document.getElementById("videoPlayer");
      const volumeControl = document.getElementById("volumeControl");
      const uploadButton = document.getElementById("uploadButton");
      const youtubeForm = document.getElementById("youtubeForm");
      const youtubeUrlInput = document.getElementById("youtubeUrlInput");
      const youtubeUrlStream = document.getElementById("streamButton");
      const stopButton = document.getElementById("stopButton");

      //Puppets:
      const puppetListElement = document.getElementById('connectedPuppets');

      //Video Additional Effects:
      const toggleInversionCheckbox = document.getElementById("optimizeButton");
      const enhanceDetailsCheckbox = document.getElementById("enhanceDetailsCheckbox");
      const optimizeColorButton = document.getElementById("optimizeColorButton");
      const optimizeBackgroundCheckbox = document.getElementById("optimizeBackground");

      // Get the modal and buttons
      const modal = document.getElementById("infoModal");
      const infoButton = document.getElementById("btn_information");
      const closeButton = document.getElementsByClassName("close")[0];

      let loopEnabled = false;
      let optimizeColorChecked = false;
      let enhanceDetailsChecked = false;
      let backgroundOptimizeChecked = false;

      //MASTER LOAD:
      // Generate ID:
      const masterPageID = generateUniqueID();
      // Connect to the playerControls namespace
      const socket = io('/playerControls', { query: { userID: masterPageID } });
      
      // Update the master page ID in the connection code snippet
      console.log("Debug Connection ID: ", masterPageID)
      const connectionCodeElement = document.getElementById('showConnectionID');
      connectionCodeElement.innerHTML = `
        КОД ДОСТУПУ: ${masterPageID}
      `;

      function generateUniqueID() {
        const characters = '0123456789';
        let result = '';
        for (let i = 0; i < 4; i++) {
          result += characters.charAt(Math.floor(Math.random() * characters.length));
        }
        return result;
      }
      
      //MASTER FUNCTIONS:
      // Function to parse the query parameter and show/hide input elements accordingly
      function parseQueryParameter() {
          const queryString = window.location.search;
          const urlParams = new URLSearchParams(queryString);
          const type = urlParams.get('type');

          // Show/hide input elements based on the type parameter
          if (type === 'local') {
              videoFileInputBox.style.display = 'block';
              youtubeUrlInput.style.display = 'none';
              //Tweak buttons
              uploadButton.style.display = 'block';
              youtubeUrlStream.style.display = 'none';
              console.log("loaded local")
          } else if (type === 'url') {
              videoFileInputBox.style.display = 'none';
              youtubeUrlInput.style.display = 'block';
              //Tweak buttons
              youtubeUrlStream.style.display = 'block';
              uploadButton.style.display = 'none';
              console.log("loaded url")
          }
      }

      // Call the function to parse the query parameter when the page loads
      window.onload = function() {
          parseQueryParameter();
      };

      //EMITTERS:

      // Handle YouTube video streaming form submission
      youtubeUrlStream.addEventListener("click", async (event) => {
        event.preventDefault();
        const youtubeUrl = youtubeUrlInput.value;

        try {
          // Extract video ID from YouTube URL
          const videoId = extractVideoId(youtubeUrl);
          // Fetch YouTube video from server
          const response = await fetch(`/youtube/${videoId}`);
          if (!response.ok) {
            throw new Error("Failed to fetch YouTube video");
          }
          // Set video source
          videoPlayer.src = URL.createObjectURL(await response.blob());

          // Send the video URL to the puppet page
          sendVideoUrl(youtubeUrl);
        } catch (error) {
          alert("Failed to stream YouTube video:", error);
        }
      });

      // Function to send video URL to puppet page
      function sendVideoUrl(url) {
        socket.emit("video url", url);
      }

      // Function to extract video ID from YouTube URL
      function extractVideoId(url) {
        // Check for different YouTube URL formats using regular expressions:
        const patterns = [
          // Shorts:
          /^https?:\/\/(?:www\.)?youtube\.com\/shorts\/([a-zA-Z0-9-_]{11})(?:[\?&].*)?$/,
          // Playlists:
          /^https?:\/\/(?:www\.)?youtube\.com\/playlist\?list=([a-zA-Z0-9-_]{24})(?:[\?&].*)?$/,
          // Mobile watch URL:
          /^https?:\/\/m\.youtube\.com\/watch\?v=([a-zA-Z0-9-_]{11})(?:[\?&].*)?$/,
          // Normal watch URL:
          /^(?:https?:\/\/)?(?:www\.)?youtu(?:be\.com\/watch\?v=)?([a-zA-Z0-9-_]{11})(?:[\?&].*)?$/,
          // "Share" button link:
          /^(?:https?:\/\/)?(?:www\.)?youtu\.be\/([a-zA-Z0-9-_]{11})(?:[\?&].*)?$/
        ];
      
        for (const pattern of patterns) {
          const match = url.match(pattern);
          if (match) {
            return match[1]; // Extract video ID from the matched pattern
          }
        }
      
        // If no match found, return null
        return null;
      }

      videoPlayer.addEventListener('play', () => {
        socket.emit("player start", videoPlayer.play())
      });

      videoPlayer.addEventListener("pause", () =>
        socket.emit("player pause", videoPlayer.pause())
      );

      videoPlayer.addEventListener("seeking", () =>
        socket.emit("player timeupdate", videoPlayer.currentTime)
      );

      volumeControl.addEventListener("input", () =>
        socket.emit("player volumeupdate", volumeControl.value)
      );

      uploadButton.addEventListener("click", function () {
        const file = videoFileInput.files[0];
        if (file) {
            const formData = new FormData();
            // Generate a unique filename
            const uniqueFilename = generateUniqueFilename(file.name);
            
            formData.append("video", file, uniqueFilename);
            formData.append("masterPageID", masterPageID);

            fetch(`/upload?userID=${masterPageID}`, {
                method: "POST",
                body: formData,
            })
            .then((response) => {
                if (response.ok) {
                    socket.emit("video uploaded", { videoId: uniqueFilename});
                    console.log("Video uploaded successfully!");
                } else {
                    console.error("Failed to upload video.");
                }
            })
            .catch((error) => {
                console.error("Error uploading video:", error);
            });
        } else {
            alert("No file selected.");
        }
      });
    
      // Function to generate a unique filename
      function generateUniqueFilename(originalFilename) {
        const timestamp = new Date().getTime(); // Get current timestamp
        const randomString = Math.random().toString(36).substring(2, 15); // Generate a random string
        const fileExtension = originalFilename.split('.').pop(); // Get the file extension
        return `${timestamp}-${randomString}.${fileExtension}`;
      }
    

      // Функция для обновления видеоплеера
      function updateVideoPlayer(file) {
        const url = URL.createObjectURL(file);
        videoPlayer.src = url;
        console.log(videoPlayer.src);
      }

      // Обработчик события загрузки страницы
      window.addEventListener("DOMContentLoaded", function () {
        // Вызываем функцию updateVideoPlayer при загрузке страницы, если есть выбранный файл
        if (videoFileInput.files[0]) {
          updateVideoPlayer(videoFileInput.files[0]);
        }
      });

      // Добавляем обработчик события change для input type="file"
      videoFileInput.addEventListener("change", function () {
        const file = this.files[0];
        updateVideoPlayer(file);
      });

      // Event listener for the STOP button
      stopButton.addEventListener("click", () => {
        // Stop the video playback on both pages
        socket.emit("stop");
        videoPlayer.pause();
        videoPlayer.currentTime = 0;
      });


      //VIDEO PARAMETERS:
      // Loop
      toggleLoopButton.addEventListener('change', () => {
        socket.emit("toggle loop", { masterPageID });
        if (toggleLoopButton.checked) {
          videoPlayer.loop = true;
        } else {
          videoPlayer.loop = false;
        }
      });

      //Inversion:
      //Toggle inversion checkbox event listener
      toggleInversionCheckbox.addEventListener("change", () => {
        // Emit the inversion status to the server
        socket.emit("toggle inversion", { masterPageID });
        // Apply the inversion effect locally on the master page
        if (toggleInversionCheckbox.checked) {
          videoPlayer.style.transform = "scaleX(-1) translateX(1%)";
        } else {
          videoPlayer.style.transform = "scaleX(1) translateX(0)";
        }
      });

      // Event listener for the "Optimize Color" checkbox
      optimizeColorButton.addEventListener("change", () => {
          socket.emit("optimize color", { masterPageID });
          // Update the state of the "Optimize Color" checkbox
          optimizeColorChecked = optimizeColorButton.checked;
          // Apply filters based on the state of both checkboxes
          applyFilters();
      });

      // Event listener for the "Enhance Details" checkbox
      enhanceDetailsCheckbox.addEventListener("change", () => {
          // Emit the enhance details event to the server along with the checkbox state
          socket.emit("toggle enhance details", enhanceDetailsCheckbox.checked, { masterPageID });
          // Apply filters based on the state of both checkboxes
          applyFilters();
      });

      optimizeBackgroundCheckbox.addEventListener("change", () => {
        // Emit the enhance details event to the server along with the checkbox state
        socket.emit("toggle back details", optimizeBackgroundCheckbox.checked, { masterPageID });
        // Apply filters based on the state of both checkboxes
        applyFilters();
      });

      // Function to apply filters based on the state of filter checkboxes
      function applyFilters() {
        let filters = "";

        if (optimizeColorButton.checked) {
            // Apply filters for optimizing color
            filters += " contrast(130%) saturate(130%)";
        }

        if (enhanceDetailsCheckbox.checked) {
            // Apply filters for enhancing details
            // Adjust as needed based on your specific enhancements
            filters += " brightness(110%) blur(0.25px)";
        }

        // Optimize Background filters (using CSS filters):
        if (optimizeBackgroundCheckbox.checked) {
          filters += " contrast(150%) drop-shadow(0 0 5px rgba(255, 0, 0, 0.5)) hue-rotate(15deg)";
        }

        // Set the combined filters to the video player
        videoPlayer.style.filter = filters || "none";
      }

      // Initial call to apply filters based on the initial state of checkboxes
      applyFilters();

      // Event listener for clicking the info button
      infoButton.addEventListener("click", () => {
          modal.style.display = "block";
      });

      // Event listener for clicking the close button or outside the modal
      closeButton.addEventListener("click", () => {
          modal.style.display = "none";
      });

      window.addEventListener("click", (event) => {
          if (event.target === modal) {
              modal.style.display = "none";
          }
      });
      
      //LISTENERS:
      socket.on("file uploaded", () => console.log("file uploaded"));

      socket.on("disconnect", () => {
        alert("Disconnected from server.");
        videoPlayer.src = null
      });

      socket.on('updatePuppets', (puppetIds) => {
        const connectedText = puppetIds.length > 0 ? `Connected Puppets: ${puppetIds}` : 'No connected puppets';
        puppetListElement.textContent = connectedText;
      });

      socket.on('error', (errorMessage) => {
        alert(errorMessage); // Display error message to the user
      });

    </script>
  </body>
</html>