<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./src/components/styles/index.css" />
    <title>Video Controller</title>
  </head>
  <body>
    <header>
      <div class="container">
        <img
          src="./src/components/img/image_1.png"
          alt="img not found"
          class="logo"
        />
        <a
          href="https://crm.ucreate.org.ua/"
          class="header__link"
          target="_blank"
          rel="noreferrer"
        >
          Посилання на сайт
        </a>
      </div>
    <main>
      <div class="container">
        <div class="container_search">
          <div class="form_search">
            <div class="info">
              <!-- Form to upload local videos -->
              <p class="text_op" ><strong>ПРОЧИТАЙТЕ ІНСТРУКЦІЮ!!!</strong></p>
              <p class="text_op" id="showConnectionID">
                Скопіююйте наступний код у вашу /video сторінку, щоб приєднатися до цього контролера.
                Код: ${masterPageID}
              </p>
              <label for="search-name" class="input_label">
                <div class="container_change">
                  <input 
                    class="input_search"
                    type="file" 
                    name="video" 
                    id="videoFile" 
                    accept="video/*" 
                    style="display: none;"
                  />
                  <svg class="input__loupe">
                    <use
                      href="../img/Loupe.svg#loupe"
                      width="20"
                      height="20"
                    ></use>
                  </svg>
                </div>
              </label>

              <!-- Form to stream YouTube videos -->
              <label for="search-name" class="input_label">
                <div class="container_change">
                  <input
                    class="input_search"
                    type="text" 
                    id="youtubeUrlInput"
                    name="search-name"
                    placeholder="https://"
                    style="display: none;" />
                </div>
              </label>
          
              <!-- VIDEO EFFECTS BUTTONS:-->
              <p class="text_op">Параметри відео</p>

              <label class="label_form" for="optimizeButton">
                Оптимізувати відео
                <span class="btn_check">
                    <input type="checkbox" id="optimizeButton" class="input_checkbox">
                    <span class="switching"></span>
                </span>
              </label>

              <label class="label_form" for="enhanceDetailsCheckbox">
                Деталізувати
                <span class="btn_check">
                    <input type="checkbox" id="enhanceDetailsCheckbox" class="input_checkbox">
                    <span class="switching"></span>
                </span>
              </label>

              <label class="label_form" for="optimizeColorButton">
                Оптимізувати колір
                <span class="btn_check">
                    <input type="checkbox" id="optimizeColorButton" class="input_checkbox">
                    <span class="switching"></span>
                </span>
              </label>

              <label class="label_form" for="optimizeBackground">
                Оптимізувати фон
                <span class="btn_check">
                    <input type="checkbox" id="optimizeBackground" class="input_checkbox">
                    <span class="switching"></span>
                </span>
              </label>
              
              <p class="text_op">Керувати відтворенням</p>
              <!-- Volume control -->
              <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="1" />

              <!-- Endlessly Loop Video button-->
              <label class="label_form" for="">
                Зациклити відео
                <span class="btn_check" id="toggleLoopButton">
                  <span class="switching"></span>
                </span>
              </label>

              <!-- Stop button -->
              <label class="label_form" for="">
                Зупинити відео примусово
                <span class="btn_check" id="stopButton">
                  <span class="switching"></span>
                </span>
              </label>

              <!-- Upload / Steam Video-->
              <label class="label_form" for="">
                Вивести на екран
                <button class="btn_submit" 
                  id="uploadButton"
                  style="display: none;">
                </button>

                <button class="btn_submit" 
                  id="streamButton" 
                  type="submit"
                  style="display: none;">
                </button>
              </label>
          
              <!-- Modal -->
              <button class = "btn_information" id="btn_information">
                Інструкція
              </button>
          
              <!-- Information Modal -->
              <div id="infoModal" class="modal">
                <!-- Modal content -->
                <div class="modal-content">
                  <span class="close">&times;</span>
                  <h2>ІНСТРУКЦІЯ З ВИКОРИСТАННЯ</h2>
                  <p><strong>Код Доступу:</strong> Додаток працює наступним чином: є сторінка-контролер та керована сторінка. 
                    Для підлючення керованої сторінки до контролера вам необхідно скопіювати код у полі "КОД ДОСТУПУ" та вставити його у 
                    текстове поле на керованій сторінці. Текстове поле викликається натиском на кнопку "Під'єднатися"
                  </p>
                  <p><strong>Трансляція</strong>:</strong> Після цього завантажте ваше відео з пристороя чи вставте посилання з ютубу, 
                    далі натисність кнопку "вивести на екран" і керуйте за допомогою медіаплеера на сторінці-контролері (тобто цій);
                    УВАГА! 
                    - Деякі відео з ютубу можуть відтворюватися без звуку, це властивість ютубу. 
                    - Також такі відео можуть здаватися "розсинхронизованими": просто розпочніть відео з початку.
                  </p>
                  <h2>ДОДАТКОВІ ЕФЕКТИ ВІДЕО</h2>
                  <p><strong>Оптимізувати колір:</strong> Enhances the color contrast and saturation of the video.</p>
                  <p><strong>Деталізувати:</strong> Enhances the sharpness and clarity of the video.</p>
                  <p><strong>Оптимізувати Відео</strong> Перевертає по горизонталі та зміщує трішечки праворуч.</p>
                  <p><strong>Оптимізувати Фон:</strong> Enhances background, affecting specific background colors and color tones.</p>
                </div>
              </div>
            </div>
          </div>

          <div class="line"></div>

          <!-- Video player -->
          <div class="video_box">
            <video id="videoPlayer" controls muted>
              <source type="video/mp4">
            </video>
          </div>
        </div>
      </div>
    </main>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const videoFileInput = document.getElementById("videoFile");
      const videoPlayer = document.getElementById("videoPlayer");
      const volumeControl = document.getElementById("volumeControl");
      const uploadButton = document.getElementById("uploadButton");
      const youtubeForm = document.getElementById("youtubeForm");
      const youtubeUrlInput = document.getElementById("youtubeUrlInput");
      const youtubeUrlStream = document.getElementById("streamButton");
      const stopButton = document.getElementById("stopButton");

      //Video Additional Effects:
      const toggleInversionCheckbox = document.getElementById("optimizeButton");
      const enhanceDetailsCheckbox = document.getElementById("enhanceDetailsCheckbox");
      const optimizeColorButton = document.getElementById("optimizeColorButton");
      const optimizeBackgroundCheckbox = document.getElementById("optimizeBackground");

      // Get the modal and buttons
      const modal = document.getElementById("infoModal");
      const infoButton = document.getElementById("btn_information");
      const closeButton = document.getElementsByClassName("close")[0];

      let loopEnabled = false;
      let optimizeColorChecked = false;
      let enhanceDetailsChecked = false;
      let backgroundOptimizeChecked = false;

      //MASTER LOAD:
      // Generate ID:
      const masterPageID = generateUniqueID();
      // Connect to the playerControls namespace
      const socket = io('/playerControls', { query: { userID: masterPageID } });
      
      // Update the master page ID in the connection code snippet
      console.log("Debug Connection ID: ", masterPageID)
      const connectionCodeElement = document.getElementById('showConnectionID');
      connectionCodeElement.innerHTML = `
        КОД ДОСТУПУ: ${masterPageID}
      `;

      function generateUniqueID() {
        return Math.random().toString(36).substring(2) + Date.now().toString(36);
      }

      //MASTER FUNCTIONS:
      // Function to parse the query parameter and show/hide input elements accordingly
      function parseQueryParameter() {
          const queryString = window.location.search;
          const urlParams = new URLSearchParams(queryString);
          const type = urlParams.get('type');

          // Show/hide input elements based on the type parameter
          if (type === 'local') {
              videoFileInput.style.display = 'block';
              youtubeUrlInput.style.display = 'none';
              //Tweak buttons
              uploadButton.style.display = 'block';
              youtubeUrlStream.style.display = 'none';
              console.log("loaded local")
          } else if (type === 'url') {
              videoFileInput.style.display = 'none';
              youtubeUrlInput.style.display = 'block';
              //Tweak buttons
              youtubeUrlStream.style.display = 'block';
              uploadButton.style.display = 'none';
              console.log("loaded url")
          }
      }

      // Call the function to parse the query parameter when the page loads
      window.onload = function() {
          parseQueryParameter();
      };

      //EMITTERS:

      // Function to toggle loop feature
      toggleLoopButton.addEventListener('click', () => {
        loopEnabled = !loopEnabled;
        videoPlayer.loop = loopEnabled;
      });


      // Handle YouTube video streaming form submission
      youtubeUrlStream.addEventListener("click", async (event) => {
        event.preventDefault();
        const youtubeUrl = youtubeUrlInput.value;

        try {
          // Extract video ID from YouTube URL
          const videoId = extractVideoId(youtubeUrl);
          // Fetch YouTube video from server
          const response = await fetch(`/youtube/${videoId}`);
          if (!response.ok) {
            throw new Error("Failed to fetch YouTube video");
          }
          // Set video source
          videoPlayer.src = URL.createObjectURL(await response.blob());

          // Send the video URL to the puppet page
          sendVideoUrl(youtubeUrl);
        } catch (error) {
          console.error("Failed to stream YouTube video:", error);
        }
      });

      // Function to send video URL to puppet page
      function sendVideoUrl(url) {
        socket.emit("video url", url);
      }

      // Function to extract video ID from YouTube URL
      function extractVideoId(url) {
        const match = url.match(/[?&]v=([^&]+)/);
        return match && match[1];
      }

      videoPlayer.addEventListener('play', () => {
        socket.emit("player start", videoPlayer.play())
      });

      videoPlayer.addEventListener("pause", () =>
        socket.emit("player pause", videoPlayer.pause())
      );

      videoPlayer.addEventListener("seeking", () =>
        socket.emit("player timeupdate", videoPlayer.currentTime)
      );

      volumeControl.addEventListener("input", () =>
        socket.emit("player volumeupdate", volumeControl.value)
      );

      uploadButton.addEventListener("click", function () {
        const file = videoFileInput.files[0];
        if (file) {
            const formData = new FormData();
            formData.append("video", file);
            formData.append("masterPageID", masterPageID);

            fetch("/upload?userID=${masterPageID}", {
                method: "POST",
                body: formData,
            })
            .then((response) => {
                if (response.ok) {
                    socket.emit("video uploaded", videoPlayer.src);
                    if (!videoPlayer.paused) {
                        socket.emit("player start", videoPlayer.play());
                    }
                    console.log("Video uploaded successfully!");
                } else {
                    console.error("Failed to upload video.");
                }
            })
            .catch((error) => {
                console.error("Error uploading video:", error);
            });
        } else {
            console.error("No file selected.");
        }
    });
    

      // Функция для обновления видеоплеера
      function updateVideoPlayer(file) {
        const url = URL.createObjectURL(file);
        videoPlayer.src = url;
        console.log(videoPlayer.src);
      }

      // Обработчик события загрузки страницы
      window.addEventListener("DOMContentLoaded", function () {
        // Вызываем функцию updateVideoPlayer при загрузке страницы, если есть выбранный файл
        if (videoFileInput.files[0]) {
          updateVideoPlayer(videoFileInput.files[0]);
        }
      });

      // Добавляем обработчик события change для input type="file"
      videoFileInput.addEventListener("change", function () {
        const file = this.files[0];
        updateVideoPlayer(file);
      });

      // Event listener for the STOP button
      stopButton.addEventListener("click", () => {
        // Stop the video playback on both pages
        socket.emit("stop");
        videoPlayer.pause();
        videoPlayer.currentTime = 0;
      });


      //VIDEO PARAMETERS:
      //Inversion:
      //Toggle inversion checkbox event listener
      toggleInversionCheckbox.addEventListener("change", () => {
        // Emit the inversion status to the server
        socket.emit("toggle inversion", { masterPageID });
        // Apply the inversion effect locally on the master page
        if (toggleInversionCheckbox.checked) {
          videoPlayer.style.transform = "scaleX(-1) translateX(1%)";
        } else {
          videoPlayer.style.transform = "scaleX(1) translateX(0)";
        }
      });

      // Event listener for the "Optimize Color" checkbox
      optimizeColorButton.addEventListener("change", () => {
          socket.emit("optimize color", { masterPageID });
          // Update the state of the "Optimize Color" checkbox
          optimizeColorChecked = optimizeColorButton.checked;
          // Apply filters based on the state of both checkboxes
          applyFilters();
      });

      // Event listener for the "Enhance Details" checkbox
      enhanceDetailsCheckbox.addEventListener("change", () => {
          // Emit the enhance details event to the server along with the checkbox state
          socket.emit("toggle enhance details", enhanceDetailsCheckbox.checked, { masterPageID });
          // Apply filters based on the state of both checkboxes
          applyFilters();
      });

      optimizeBackgroundCheckbox.addEventListener("change", () => {
        // Emit the enhance details event to the server along with the checkbox state
        socket.emit("toggle back details", optimizeBackgroundCheckbox.checked, { masterPageID });
        // Apply filters based on the state of both checkboxes
        applyFilters();
      });

      // Function to apply filters based on the state of filter checkboxes
      function applyFilters() {
        let filters = "";

        if (optimizeColorButton.checked) {
            // Apply filters for optimizing color
            filters += " contrast(130%) saturate(130%)";
        }

        if (enhanceDetailsCheckbox.checked) {
            // Apply filters for enhancing details
            // Adjust as needed based on your specific enhancements
            filters += " brightness(110%) blur(0.25px)";
        }

        // Optimize Background filters (using CSS filters):
        if (optimizeBackgroundCheckbox.checked) {
          filters += " contrast(150%) drop-shadow(0 0 5px rgba(255, 0, 0, 0.5)) hue-rotate(15deg)";
        }

        // Set the combined filters to the video player
        videoPlayer.style.filter = filters || "none";
      }

      // Initial call to apply filters based on the initial state of checkboxes
      applyFilters();

      // Event listener for clicking the info button
      infoButton.addEventListener("click", () => {
          modal.style.display = "block";
      });

      // Event listener for clicking the close button or outside the modal
      closeButton.addEventListener("click", () => {
          modal.style.display = "none";
      });

      window.addEventListener("click", (event) => {
          if (event.target === modal) {
              modal.style.display = "none";
          }
      });
      
      //LISTENERS:
      socket.on("file uploaded", () => console.log("file uploaded"));

    </script>
  </body>
</html>