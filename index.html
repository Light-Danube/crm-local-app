<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload Video</title>
    <style>
      h1 {
        color: lightgray;
      }
      body {
        margin: 40px auto;
        max-width: 650px;
        background-color: #444;
      }
    </style>
  </head>
  <body>
    <h1>Upload Video</h1>
    <input type="file" name="video" id="videoFile" accept="video/*" />
    <button id="uploadButton">Upload</button>
    <video id="videoPlayer" width="650" controls muted>
      <source type="video/mp4" />
      <!-- src="/uploads/test.mp4" -->
      Your browser does not support the video tag.
    </video>
    <input
      type="range"
      id="volumeControl"
      min="0"
      max="1"
      step="0.01"
      value="1"
    />
  </body>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io("/playerControls");

    const videoFileInput = document.getElementById("videoFile");
    const videoPlayer = document.getElementById("videoPlayer");
    const volumeControl = document.getElementById("volumeControl");
    const uploadButton = document.getElementById("uploadButton");

    socket.on("file uploaded", () => console.log("file uploaded"));

    videoPlayer.addEventListener("play", () =>
      socket.emit("player start", videoPlayer.play())
    );

    videoPlayer.addEventListener("pause", () =>
      socket.emit("player pause", videoPlayer.pause())
    );

    videoPlayer.addEventListener("seeking", () =>
      socket.emit("player timeupdate", videoPlayer.currentTime)
    );

    volumeControl.addEventListener("input", () =>
      socket.emit("player volumeupdate", volumeControl.value)
    );

    uploadButton.addEventListener("click", function () {
      const file = videoFileInput.files[0];
      if (file) {
        const formData = new FormData();
        formData.append("video", file);

        fetch("/upload", {
          method: "POST",
          body: formData,
        })
          .then((response) => {
            if (response.ok) {
              socket.emit("player timeupdate", videoPlayer.currentTime);
              if (!videoPlayer.paused) {
                socket.emit("player start", videoPlayer.play());
              }
              console.log("Video uploaded successfully!");
            } else {
              console.error("Failed to upload video.");
            }
          })
          .catch((error) => {
            console.error("Error uploading video:", error);
          });
      } else {
        console.error("No file selected.");
      }
    });

    // Функция для обновления видеоплеера
    function updateVideoPlayer(file) {
      const url = URL.createObjectURL(file);
      videoPlayer.src = url;
      console.log(videoPlayer.src);
    }

    // Обработчик события загрузки страницы
    window.addEventListener("DOMContentLoaded", function () {
      // Вызываем функцию updateVideoPlayer при загрузке страницы, если есть выбранный файл
      if (videoFileInput.files[0]) {
        updateVideoPlayer(videoFileInput.files[0]);
      }
    });

    // Добавляем обработчик события change для input type="file"
    videoFileInput.addEventListener("change", function () {
      const file = this.files[0];
      updateVideoPlayer(file);
    });
  </script>
</html>
